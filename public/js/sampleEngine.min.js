!function(){var e=$("#title").html(),t=0,n="description",a=new Object,i=new Object,s=!1,o=!1,r=[],l=!1,d=[0,1,2],c=0;function h(){o=!0;var e=r;r=[],$("#sync_status").text("درحال ذخیره سازی..."),$.ajax({dataType:"json",url:"/$/"+sample_id+"/items",method:"post",data:{items:e}}).always(function(t,n){if("success"!=n){$("#sync_alert").removeClass("d-none"),$("#sync_status").text("درحال تلاش دوباره...");for(var a=0;a<e.length;a++)r.push(e[a]);i=d[Math.min(Math.max(0,++c),d.length-1)],setTimeout(h,1e3*i)}else $("#sync_alert").addClass("d-none"),c=0,$("#sync_status").text("ذخیره شده"),r.length?h():o=!1;var i})}function u(){t=parseInt(Math.min(Math.max(0,++t),items.length+1)),location.hash="#"+t}function p(){$("#nav-count option").removeAttr("selected"),$("#nav-count select").is(":disabled")&&$("#nav-count select").removeAttr("disabled"),$("option[value="+t+"]").attr("selected","selected");var e=100*t/items.length;$("#progress").css("width",e+"%").attr("aria-valuenow",e),0==t?$("#nav-prev").addClass("disabled").removeAttr("href"):$("#nav-prev").removeClass("disabled").attr("href","#"+(t-1)),t>items.length?$("#nav-next").addClass("disabled").removeAttr("href"):$("#nav-next").removeClass("disabled").attr("href","#"+(t+1))}a.text=function(e){$("#title").html(e.text)},i.optional=function(e){var n=$("#item");e.answer.options.forEach(function(t,a){var i=a+1,s=$("#template div.radio").eq(0).clone();$("input",s).val(i).attr("name","options").attr("id",i),e.user_answered==i&&$("input",s).attr("checked","checked"),$("label",s).attr("for",i),$("label span",s).attr("data-number",i),$("label",s).append(t),s.appendTo(n)}),$("input",n).on("click.answer",function(){if(s)return!0;$("input",n).off("click.answer"),$("input",n).off("clicked.answer"),function(e){e=parseInt(e),items[t-1].user_answered=e,function(e,t){if("undefined"!=typeof Storage){var n=[];(sData=localStorage.getItem(sample_id))&&(n=sData.split(",")),n[e]=t,localStorage.setItem(sample_id,n.join(","))}r.push([e,t]),o||h()}(t-1,e);var n=$("input[value="+e+"]").parents("div.radio");$("#item div.radio").each(function(){this!=n[0]&&($("input",this).attr("disabled","disabled"),$(this).fadeTo("fast",.2))}),t=l?function(){for(var e=0;e<items.length;e++)if(!items[e].user_answered)return e;return}()||items.length:t,setTimeout(u,500)}($(this).val())}),$("input",n).on("clicked.answer",function(){$(this).trigger("click.answer")})},$(document).on("keyup",function(e){if(s)return!0;if(e.ctrlKey||e.shiftKey||e.altKey||-1!=["Control","Shift","Alt","Meta"].indexOf(e.key))return!0;if("Enter"==e.key||"ArrowLeft"==e.key?u():"ArrowRight"==e.key&&(t=parseInt(Math.min(Math.max(0,--t),items.length+1)),location.hash="#"+t),/^(Digit|Numpad)\d$/.test(e.code)){var n=e.code.replace(/Digit|Numpad/,"");$("input[value="+n+"]").trigger("clicked.answer")}}),$(window).on("hashchange",function(){if(s)return!0;/^#\d+$/.test(location.hash)&&(t=parseInt(location.hash.replace("#","")),function(){s=!0;var o=$("#item");if(0==t)return n="description",$("#title").html(e),$("#description").show(),o.hide(),p(),void(s=!1);if(t>items.length){$("#skip").is(":checked")||$("#skip").trigger("click"),n="close",o.hide(),$("#description").hide(),$("#title").html("پایان نمونه‌گیری"),$("#empty_list *").remove();var r=!1;return items.forEach(function(e,t){e.user_answered||(r=!0,$("#empty_list").append('<a class="d-inline-block m-2" href="#'+(t+1)+'">'+(t+1)+"</a>"))}),console.log(r),r||$("#close-btn").removeClass("d-none"),$("#close").show(),p(),void(s=!1)}var l=items[t-1];"item"!=n&&($("#description").hide(),$("#close").hide(),n="item",o.show()),$("#title").fadeTo("fast",0),o.fadeTo("fast",0,function(){$(this).css("width",$(this).width()),$(this).children().remove(),a[l.type](l),i[l.answer.type](l),$(this).css("width","initial").fadeTo("fast",1),$("#title").fadeTo("fast",1),p(),s=!1})}())}),$(document).ready(function(){$("#skip").on("click",function(){l=!!$(this).is(":checked")});var e=$('<select class="form-control"></select>');e.on("change",function(){if(s)return!1;location.hash="#"+$(this).val(),$(this).attr("disabled","disabled")}),$('<option value="0">#</option>').appendTo(e),items.forEach(function(t,n){$('<option value="'+(n+1)+'">'+(n+1)+"</option>").appendTo(e)}),$('<option value="'+(items.length+1)+'">پایان</option>').appendTo(e),$("#nav-count").append(e),/^#\d+$/.test(location.hash)&&$(window).trigger("hashchange"),"undefined"!=typeof Storage&&(data=[],(sData=localStorage.getItem(sample_id))&&(data=sData.split(",")),data.forEach(function(e,t){!items[t].user_answered&&e&&(items[t].user_answered=e,r.push([t,e]))}),r.length&&h())}),$("#download, #download-close").on("click",function(){for(var e=[sample_id],t=0;t<items.length;t++)e.push(items[t].user_answered);var n=e.join("\n"),a="plain/text",i=sample_id+".csv",s=new Blob([n],{type:a}),o=document.createElement("a");return o.download=i,o.href=URL.createObjectURL(s),o.dataset.downloadurl=[a,o.download,o.href].join(":"),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(function(){URL.revokeObjectURL(o.href)},1500),!1})}();