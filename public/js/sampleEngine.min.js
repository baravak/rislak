function aliastext(e,t,a){if("null"==e)return null;if("#prerequisites."==e.substr(0,15)){for(var n=0;n<t.length;n++)if(t[n].label==e.substr(15))return t[n].user_answered?t[n].user_answered:null;return e}return e}function conditext(e,t,a){var n=e.split(/\s/,3),i=aliastext(n[0],t,a),r=aliastext(n[2],t,a);switch(n[1]){case"<>":return i!=r}}!function(){var e=0,t="description",a=new Object,n=new Object,i=!1,r=!1,o=[],s=!1,l=[0,1,2],d=0;function c(e,t,a){if("undefined"!=typeof Storage){var n=[];(sData=localStorage.getItem(sample_id))&&(n=JSON.parse(sData)),null==a?n[e]=t:("object"!=typeof n[e]&&(n[e]=[]),n[e][a]=t),localStorage.setItem(sample_id,JSON.stringify(n))}o.push([e,t,a]),r||p()}function p(){r=!0;var e=o;o=[],$("#sync_status").text("درحال ذخیره سازی..."),$.ajax({dataType:"json",url:"/$/"+sample_id+"/items",method:"post",data:{items:e}}).always(function(t,a){if("success"!=a){$("#sync_alert").removeClass("d-none"),$("#sync_status").text("درحال تلاش دوباره...");for(var n=0;n<e.length;n++)o.push(e[n]);i=l[Math.min(Math.max(0,++d),l.length-1)],setTimeout(p,1e3*i)}else $("#sync_alert").addClass("d-none"),d=0,$("#sync_status").text("ذخیره شده"),o.length?p():r=!1;var i})}function u(){if(!i){i=!0;var r=null;$("[data-panel]").each(function(){"block"==$(this).css("display")&&(r=$(this))}),r.trigger("panel:hide",[t,e,items]),r.fadeOut("fast",function(){if("item"==t){var r=items[e-1];$("#item-section").html(""),n[r.type](r),a[r.answer.type](r)}!function(){$("#nav-count option").removeAttr("selected"),$("#nav-count select").is(":disabled")&&$("#nav-count select").removeAttr("disabled");var a=$("#nav-count option[value="+("item"==t?e:t)+"]");a.attr("selected","selected");var n="item"==t?100*e/items.length:0;$("#progress").css("width",n+"%").attr("aria-valuenow",n),a.prev()[0]?$("#nav-prev").removeClass("disabled").attr("href","#"+a.prev().val()):$("#nav-prev").addClass("disabled").removeAttr("href");a.next()[0]?$("#nav-next").removeClass("disabled").attr("href","#"+a.next().val()):$("#nav-next").addClass("disabled").removeAttr("href")}(),$("[data-panel="+t+"]").trigger("panel:show",[t,e,items]),$("[data-panel="+t+"]").fadeIn("fast",function(){"item"!=t&&(e=0),i=!1})})}}function f(){var a=$("#nav-count option[value="+("item"==t?e:t)+"]");a.next().val()&&(location.hash="#"+a.next().val())}n.text=function(e){$("[data-panel=item] .card-title").html(e.text)},n.image_url=function(e){var t;$("[data-panel=item] .card-title").html(""),t="object"==typeof e.image_url?$(e.image_url).addClass("w-100"):$('<img src="'+e.image_url+'.png" class="w-100"/>');var a=$('<div class="w-50 m-auto"></div>');t.appendTo(a),a.appendTo($("[data-panel=item] .card-title"))},a.table_radio=function(t){var a=$("#item-section"),n=$("<table class='table table-hover'></table>"),r=$('<tr class="p-2"></tr>').appendTo(n);$("<th></th>").html("#").appendTo(r),t.answer.headers.forEach(function(e,t){(e.condition&&conditext(e.condition,prerequisite,items)||!e.condition)&&(title=aliastext(e.text,prerequisite,items),$('<th class="p-2"></th>').html(title).appendTo(r))});var o=$("<tbody></tbody>");t.answer.rows.forEach(function(e,a){var n=$("<tr ></tr>");$("<td></td>").html(e).appendTo(n),t.answer.headers.forEach(function(e,t){var i=a+1;if(e.condition&&conditext(e.condition,prerequisite,items)||!e.condition){var r=$("#template div.radio").eq(0).clone();$("input",r).val(i).attr("name","options["+t+"]").attr("id",i+"_"+t),$("label",r).attr("for",i+"_"+t),$("label span",r).attr("data-number",i),$("<td></td>").html(r).appendTo(n)}}),n.appendTo(o)}),o.appendTo(n),n.appendTo(a),$("div.radio",a).addClass("m-0"),$(":radio",a).trigger("clicked.answer"),$(":radio",a).on("click.answer",function(){if(i)return!0;var t,a;t=$(this).val(),a=$(this).attr("name").match(/\[(\d+)\]$/)[1],t=parseInt(t),items[e-1].user_answered=[],items[e-1].user_answered[a]=t,c(e,t,parseInt(a))}),$("input",a).on("clicked.answer",function(){$(this).trigger("click.answer")})},a.optional=function(t){var a=$("#item-section");"image_url"==t.type&&$('<div class="row"></div>').appendTo(a),t.answer.options.forEach(function(e,n){var i,r=n+1,o=$("#template div.radio").eq(0).clone();(o.addClass(4==t.answer.tiles?"col-3":"optional_images"==t.answer.type?"col-4":"col-12"),$("input",o).val(r).attr("name","options").attr("id",r),t.user_answered==r&&$("input",o).attr("checked","checked"),$("label",o).attr("for",r),$("label span",o).attr("data-number",r),"optional_images"==t.answer.type)?(i="object"==typeof e?$(e).addClass("w-75"):$('<img src="'+e+'.png" class="w-75"/>'),$("label",o).append(i),o.appendTo($("div.row",a))):($("label",o).append(e),o.appendTo(a))}),$("input",a).on("click.answer",function(){if(i)return!0;$("input",a).off("click.answer"),$("input",a).off("clicked.answer"),function(t){t=parseInt(t),items[e-1].user_answered=t,c(e,t);var a=$("input[value="+t+"]").parents("div.radio");$("#item-section div.radio").each(function(){this!=a[0]&&($("input",this).attr("disabled","disabled"),$(this).fadeTo("fast",.2))}),e=s?function(){for(var e=0;e<items.length;e++)if(!items[e].user_answered)return e;return}()||items.length:e,setTimeout(f,500)}($(this).val())}),$("input",a).on("clicked.answer",function(){$(this).trigger("click.answer")})},a.optional_images=a.optional,$(document).on("keyup",function(a){if(i)return!0;if(a.ctrlKey||a.shiftKey||a.altKey||-1!=["Control","Shift","Alt","Meta"].indexOf(a.key))return!0;var n;if("Enter"==a.key||"ArrowLeft"==a.key?f():"ArrowRight"==a.key&&(n=$("option[value="+("item"==t?e:t)+"]")).prev().val()&&(location.hash="#"+n.prev().val()),/^(Digit|Numpad)\d$/.test(a.code)){var r=a.code.replace(/Digit|Numpad/,"");$("input[value="+r+"]:radio").trigger("clicked.answer")}}),$(window).on("hashchange",function(){if(i)return!0;var a=location.hash.replace("#","");if(/^\d+$/.test(a))t="item",a=parseInt(a),e=Math.min(Math.max(1,a),items.length);else{t=-1!=["description","information","close"].indexOf(a)?a:"description"}u()}),$(document).ready(function(){$("#skip").on("click",function(){s=!!$(this).is(":checked")});var e=$('<select class="form-control"></select>');e.on("change",function(){if(i)return!1;location.hash="#"+$(this).val(),$(this).attr("disabled","disabled")}),$('<option value="description">توضیحات</option>').appendTo(e),prerequisite&&$('<option value="information">اطلاعات</option>').appendTo(e),items.forEach(function(t,a){$('<option value="'+(a+1)+'">'+(a+1)+"</option>").appendTo(e)}),$('<option value="close">پایان</option>').appendTo(e),$("#nav-count").append(e),$(window).trigger("hashchange"),"undefined"!=typeof Storage&&(data=[],(sData=localStorage.getItem(sample_id))&&(data=JSON.parse(sData)),data.forEach(function(e,t){console.log(e),!items[t].user_answered&&e&&(items[t].user_answered=e,"object"==typeof e?e.forEach(function(e,a){o.push([t,e,a])}):o.push([t,e]))}),o.length&&p())}),$("#download, #download-close").on("click",function(){for(var e=[sample_id],t=0;t<items.length;t++)e.push(items[t].user_answered||null);var a=e.join("\n"),n=[];$("input, select, textarea","[data-panel=information] form").each(function(){n.push($(this).val().replace(",",""))}),a=a.replace(/^([^\n]+)/,"$1,"+n.join(","));var i="plain/text",r=sample_id+".csv",o=new Blob([a],{type:i}),s=document.createElement("a");return s.download=r,s.href=URL.createObjectURL(o),s.dataset.downloadurl=[i,s.download,s.href].join(":"),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(function(){URL.revokeObjectURL(s.href)},1500),!1}),$("#nav-prev, #nav-next").on("click",function(){return!i})}(),$("[data-panel=information] form").on("statio:done",function(e,t){var a=this;t.is_ok?$(this).attr("data-on-request","false"):t.is_ok||setTimeout(function(){$(a).trigger("submit")},5e3)}),$("[data-panel=information]").on("panel:hide",function(e,t,a){var n={};jQuery($("form","[data-panel=information]")).serializeArray().map(function(e){n[e.name]?("string"==typeof n[e.name]&&(n[e.name]=[n[e.name]]),n[e.name].push(e.value)):n[e.name]=e.value});var i=[];for(var r in n)if(null!=r){var o=r.match(/^prerequisites\[(\d)\]\[(\d)\]/);i[o[1]]||(i[o[1]]=[]),i[o[1]][o[2]]=n[r]}i.forEach(function(e,t){prerequisite[e[0]-1]&&(prerequisite[e[0]-1].user_answered=e[1])}),"true"!=$("form",this).attr("data-on-request")&&($("form",this).attr("data-on-request","true"),$("form",this).trigger("submit"))});