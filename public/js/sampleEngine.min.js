!function(){var e=0,t="description",a=new Object,n=!1,i=!1,o=[],s=!1,r=[0,1,2],l=0;function d(){i=!0;var e=o;o=[],$("#sync_status").text("درحال ذخیره سازی..."),$.ajax({dataType:"json",url:"/$/"+sample_id+"/items",method:"post",data:{items:e}}).always(function(t,a){if("success"!=a){$("#sync_alert").removeClass("d-none"),$("#sync_status").text("درحال تلاش دوباره...");for(var n=0;n<e.length;n++)o.push(e[n]);s=r[Math.min(Math.max(0,++l),r.length-1)],setTimeout(d,1e3*s)}else $("#sync_alert").addClass("d-none"),l=0,$("#sync_status").text("ذخیره شده"),o.length?d():i=!1;var s})}function c(){if(!n){n=!0;var i=null;$("[data-panel]").each(function(){"block"==$(this).css("display")&&(i=$(this))}),i.trigger("panel:hide",[t,e,items]),i.fadeOut("fast",function(){if("item"==t){var i=items[e-1];$("#item-section").html(""),a[i.answer.type](i)}!function(){$("#nav-count option").removeAttr("selected"),$("#nav-count select").is(":disabled")&&$("#nav-count select").removeAttr("disabled");var a=$("#nav-count option[value="+("item"==t?e:t)+"]");a.attr("selected","selected");var n=100*e/items.length;$("#progress").css("width",n+"%").attr("aria-valuenow",n),a.prev()[0]?$("#nav-prev").removeClass("disabled").attr("href","#"+a.prev().val()):$("#nav-prev").addClass("disabled").removeAttr("href");a.next()[0]?$("#nav-next").removeClass("disabled").attr("href","#"+a.next().val()):$("#nav-next").addClass("disabled").removeAttr("href")}(),$("[data-panel="+t+"]").trigger("panel:show",[t,e,items]),$("[data-panel="+t+"]").fadeIn("fast",function(){"item"!=t&&(e=0),n=!1})})}}function u(){var a=$("#nav-count option[value="+("item"==t?e:t)+"]");a.next().val()&&(location.hash="#"+a.next().val())}a.optional=function(t){var a=$("#item-section");t.answer.options.forEach(function(e,n){var i=n+1,o=$("#template div.radio").eq(0).clone();$("input",o).val(i).attr("name","options").attr("id",i),t.user_answered==i&&$("input",o).attr("checked","checked"),$("label",o).attr("for",i),$("label span",o).attr("data-number",i),$("label",o).append(e),o.appendTo(a)}),$("input",a).on("click.answer",function(){if(n)return!0;$("input",a).off("click.answer"),$("input",a).off("clicked.answer"),function(t){t=parseInt(t),items[e-1].user_answered=t,function(e,t){if("undefined"!=typeof Storage){var a=[];(sData=localStorage.getItem(sample_id))&&(a=sData.split(",")),a[e]=t,localStorage.setItem(sample_id,a.join(","))}o.push([e,t]),i||d()}(e,t);var a=$("input[value="+t+"]").parents("div.radio");$("#item-section div.radio").each(function(){this!=a[0]&&($("input",this).attr("disabled","disabled"),$(this).fadeTo("fast",.2))}),e=s?function(){for(var e=0;e<items.length;e++)if(!items[e].user_answered)return e;return}()||items.length:e,setTimeout(u,500)}($(this).val())}),$("input",a).on("clicked.answer",function(){$(this).trigger("click.answer")}),$("[data-panel=item] .card-title").html(t.text)},$(document).on("keyup",function(a){if(n)return!0;if(a.ctrlKey||a.shiftKey||a.altKey||-1!=["Control","Shift","Alt","Meta"].indexOf(a.key))return!0;var i;if("Enter"==a.key||"ArrowLeft"==a.key?u():"ArrowRight"==a.key&&(i=$("option[value="+("item"==t?e:t)+"]")).prev().val()&&(location.hash="#"+i.prev().val()),/^(Digit|Numpad)\d$/.test(a.code)){var o=a.code.replace(/Digit|Numpad/,"");$("input[value="+o+"]").trigger("clicked.answer")}}),$(window).on("hashchange",function(){if(n)return!0;var a=location.hash.replace("#","");if(/^\d+$/.test(a))t="item",a=parseInt(a),e=Math.min(Math.max(1,a),items.length);else{t=-1!=["description","information","close"].indexOf(a)?a:"description"}c()}),$(document).ready(function(){$("#skip").on("click",function(){s=!!$(this).is(":checked")});var e=$('<select class="form-control"></select>');e.on("change",function(){if(n)return!1;location.hash="#"+$(this).val(),$(this).attr("disabled","disabled")}),$('<option value="description">توضیحات</option>').appendTo(e),prerequisite&&$('<option value="information">اطلاعات</option>').appendTo(e),items.forEach(function(t,a){$('<option value="'+(a+1)+'">'+(a+1)+"</option>").appendTo(e)}),$('<option value="close">پایان</option>').appendTo(e),$("#nav-count").append(e),$(window).trigger("hashchange"),"undefined"!=typeof Storage&&(data=[],(sData=localStorage.getItem(sample_id))&&(data=sData.split(",")),data.forEach(function(e,t){!items[t].user_answered&&e&&(items[t].user_answered=e,o.push([t,e]))}),o.length&&d())}),$("#download, #download-close").on("click",function(){for(var e=[sample_id],t=0;t<items.length;t++)e.push(items[t].user_answered);var a=e.join("\n"),n="plain/text",i=sample_id+".csv",o=new Blob([a],{type:n}),s=document.createElement("a");return s.download=i,s.href=URL.createObjectURL(o),s.dataset.downloadurl=[n,s.download,s.href].join(":"),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(function(){URL.revokeObjectURL(s.href)},1500),!1}),$("#nav-prev, #nav-next").on("click",function(){return!n})}(),$("[data-panel=information] form").on("statio:done",function(e,t){var a=this;if(t.is_ok)return console.log(this),void $(this).attr("data-on-request","false");t.is_ok||setTimeout(function(){$(a).trigger("submit")},5e3)}),$("[data-panel=information]").on("panel:hide",function(e,t,a){"true"!=$("form",this).attr("data-on-request")&&($("form",this).attr("data-on-request","true"),$("form",this).trigger("submit"))});