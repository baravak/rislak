!function(){var e=0,t="description",a=new Object,n=new Object,i=!1,o=!1,s=[],r=!1,l=[0,1,2],d=0;function c(){o=!0;var e=s;s=[],$("#sync_status").text("درحال ذخیره سازی..."),$.ajax({dataType:"json",url:"/$/"+sample_id+"/items",method:"post",data:{items:e}}).always(function(t,a){if("success"!=a){$("#sync_alert").removeClass("d-none"),$("#sync_status").text("درحال تلاش دوباره...");for(var n=0;n<e.length;n++)s.push(e[n]);i=l[Math.min(Math.max(0,++d),l.length-1)],setTimeout(c,1e3*i)}else $("#sync_alert").addClass("d-none"),d=0,$("#sync_status").text("ذخیره شده"),s.length?c():o=!1;var i})}function p(){if(!i){i=!0;var o=null;$("[data-panel]").each(function(){"block"==$(this).css("display")&&(o=$(this))}),o.trigger("panel:hide",[t,e,items]),o.fadeOut("fast",function(){if("item"==t){var o=items[e-1];$("#item-section").html(""),n[o.type](o),a[o.answer.type](o)}!function(){$("#nav-count option").removeAttr("selected"),$("#nav-count select").is(":disabled")&&$("#nav-count select").removeAttr("disabled");var a=$("#nav-count option[value="+("item"==t?e:t)+"]");a.attr("selected","selected");var n="item"==t?100*e/items.length:0;$("#progress").css("width",n+"%").attr("aria-valuenow",n),a.prev()[0]?$("#nav-prev").removeClass("disabled").attr("href","#"+a.prev().val()):$("#nav-prev").addClass("disabled").removeAttr("href");a.next()[0]?$("#nav-next").removeClass("disabled").attr("href","#"+a.next().val()):$("#nav-next").addClass("disabled").removeAttr("href")}(),$("[data-panel="+t+"]").trigger("panel:show",[t,e,items]),$("[data-panel="+t+"]").fadeIn("fast",function(){"item"!=t&&(e=0),i=!1})})}}function u(){var a=$("#nav-count option[value="+("item"==t?e:t)+"]");a.next().val()&&(location.hash="#"+a.next().val())}n.text=function(e){$("[data-panel=item] .card-title").html(e.text)},n.image_url=function(e){var t;$("[data-panel=item] .card-title").html(""),t="object"==typeof e.image_url?$(e.image_url).addClass("w-100"):$('<img src="'+e.image_url+'.png" class="w-100"/>');var a=$('<div class="w-50 m-auto"></div>');t.appendTo(a),a.appendTo($("[data-panel=item] .card-title"))},a.optional=function(t){var a=$("#item-section");"image_url"==t.type&&$('<div class="row"></div>').appendTo(a),t.answer.options.forEach(function(e,n){var i,o=n+1,s=$("#template div.radio").eq(0).clone();(s.addClass(4==t.answer.tiles?"col-3":"optional_images"==t.answer.type?"col-4":"col-12"),$("input",s).val(o).attr("name","options").attr("id",o),t.user_answered==o&&$("input",s).attr("checked","checked"),$("label",s).attr("for",o),$("label span",s).attr("data-number",o),"optional_images"==t.answer.type)?(i="object"==typeof e?$(e).addClass("w-75"):$('<img src="'+e+'.png" class="w-75"/>'),$("label",s).append(i),s.appendTo($("div.row",a))):($("label",s).append(e),s.appendTo(a))}),$("input",a).on("click.answer",function(){if(i)return!0;$("input",a).off("click.answer"),$("input",a).off("clicked.answer"),function(t){t=parseInt(t),items[e-1].user_answered=t,function(e,t){if("undefined"!=typeof Storage){var a=[];(sData=localStorage.getItem(sample_id))&&(a=sData.split(",")),a[e]=t,localStorage.setItem(sample_id,a.join(","))}s.push([e,t]),o||c()}(e,t);var a=$("input[value="+t+"]").parents("div.radio");$("#item-section div.radio").each(function(){this!=a[0]&&($("input",this).attr("disabled","disabled"),$(this).fadeTo("fast",.2))}),e=r?function(){for(var e=0;e<items.length;e++)if(!items[e].user_answered)return e;return}()||items.length:e,setTimeout(u,500)}($(this).val())}),$("input",a).on("clicked.answer",function(){$(this).trigger("click.answer")})},a.optional_images=a.optional,$(document).on("keyup",function(a){if(i)return!0;if(a.ctrlKey||a.shiftKey||a.altKey||-1!=["Control","Shift","Alt","Meta"].indexOf(a.key))return!0;var n;if("Enter"==a.key||"ArrowLeft"==a.key?u():"ArrowRight"==a.key&&(n=$("option[value="+("item"==t?e:t)+"]")).prev().val()&&(location.hash="#"+n.prev().val()),/^(Digit|Numpad)\d$/.test(a.code)){var o=a.code.replace(/Digit|Numpad/,"");$("input[value="+o+"]").trigger("clicked.answer")}}),$(window).on("hashchange",function(){if(i)return!0;var a=location.hash.replace("#","");if(/^\d+$/.test(a))t="item",a=parseInt(a),e=Math.min(Math.max(1,a),items.length);else{t=-1!=["description","information","close"].indexOf(a)?a:"description"}p()}),$(document).ready(function(){$("#skip").on("click",function(){r=!!$(this).is(":checked")});var e=$('<select class="form-control"></select>');e.on("change",function(){if(i)return!1;location.hash="#"+$(this).val(),$(this).attr("disabled","disabled")}),$('<option value="description">توضیحات</option>').appendTo(e),prerequisite&&$('<option value="information">اطلاعات</option>').appendTo(e),items.forEach(function(t,a){$('<option value="'+(a+1)+'">'+(a+1)+"</option>").appendTo(e)}),$('<option value="close">پایان</option>').appendTo(e),$("#nav-count").append(e),$(window).trigger("hashchange"),"undefined"!=typeof Storage&&(data=[],(sData=localStorage.getItem(sample_id))&&(data=sData.split(",")),data.forEach(function(e,t){!items[t].user_answered&&e&&(items[t].user_answered=e,s.push([t,e]))}),s.length&&c())}),$("#download, #download-close").on("click",function(){for(var e=[sample_id],t=0;t<items.length;t++)e.push(items[t].user_answered||null);var a=e.join("\n"),n=[];$("input, select, textarea","[data-panel=information] form").each(function(){n.push($(this).val().replace(",",""))}),a=a.replace(/^([^\n]+)/,"$1,"+n.join(","));var i="plain/text",o=sample_id+".csv",s=new Blob([a],{type:i}),r=document.createElement("a");return r.download=o,r.href=URL.createObjectURL(s),r.dataset.downloadurl=[i,r.download,r.href].join(":"),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(function(){URL.revokeObjectURL(r.href)},1500),!1}),$("#nav-prev, #nav-next").on("click",function(){return!i})}(),$("[data-panel=information] form").on("statio:done",function(e,t){var a=this;t.is_ok?$(this).attr("data-on-request","false"):t.is_ok||setTimeout(function(){$(a).trigger("submit")},5e3)}),$("[data-panel=information]").on("panel:hide",function(e,t,a){"true"!=$("form",this).attr("data-on-request")&&($("form",this).attr("data-on-request","true"),$("form",this).trigger("submit"))});